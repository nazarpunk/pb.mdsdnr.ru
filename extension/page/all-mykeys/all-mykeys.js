"use strict";
document.title = `Подписать`;
{
    const $form = document.querySelector(`form`);
    $form.autocomplete = `off`;
    const $password = $form.querySelector(`[type=password]`);
    $password.classList.add(`form-control`);
    const $sec = $form.querySelector(`[type=file]`);
    $sec.accept = `.sec`;
    const $submit = $form.querySelector(`[type=submit]`);
    $submit.classList.add(`btn`, `btn-primary`);
    $form.autocomplete = `off`;
    document.querySelectorAll(`.errorSummary`).forEach($elem => $elem.classList.add(`alert`, `alert-danger`));
    const b64toBlob = (b64Data, contentType = 'application/octet-stream', sliceSize = 512) => {
        let byteCharacters = atob(b64Data);
        let byteArrays = [];
        for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
            let slice = byteCharacters.slice(offset, offset + sliceSize);
            let byteNumbers = new Array(slice.length);
            for (let i = 0; i < slice.length; i++) {
                byteNumbers[i] = slice.charCodeAt(i);
            }
            let byteArray = new Uint8Array(byteNumbers);
            byteArrays.push(byteArray);
        }
        return new Blob(byteArrays, { type: contentType });
    };
    const indexOfSubmit = `window.parent.$.fn.yiiGridView.update`;
    const params = new URLSearchParams(window.location.search);
    if (params.has(`clientId`) && params.has(`type`)) {
        const clientId = params.get(`clientId`);
        const types = JSON.parse(params.get(`type`) || `{}`);
        chrome.runtime.sendMessage(document.head.dataset.extensionId || ``, { getClientSignature: clientId }, (signature) => {
            let typeCurrent = [2, 0, 1].find(type => types[type].need && !types[type].complete);
            if (typeCurrent === undefined)
                return;
            $submit.insertAdjacentHTML('beforebegin', `<label class="switch-wrap"><div class="switch"><input type="checkbox" checked autocomplete="off" name="save"><div><span></span></div></div>Сохранить как &laquo;${types[typeCurrent].name}&raquo;</label>`);
            $form.addEventListener(`submit`, e => {
                const $checkbox = $form.querySelector(`[type=checkbox]`);
                const formData = new FormData($form);
                $submit.disabled = true;
                if ($checkbox === null || !$checkbox.checked || $sec.files.length === 0)
                    return;
                e.preventDefault();
                fetch($form.action, {
                    method: $form.method,
                    body: new FormData($form)
                })
                    .then(response => response.text())
                    .then(data => {
                    const isSubmit = data.indexOf(indexOfSubmit) >= 0;
                    if (!isSubmit)
                        return $form.submit();
                    e.preventDefault();
                    const fileReader = new FileReader();
                    fileReader.onload = e => {
                        chrome.runtime.sendMessage(document.head.dataset.extensionId || ``, {
                            saveSignature: {
                                client: clientId,
                                type: typeCurrent,
                                password: formData.get(`QuickKeysForm[passphrase]`),
                                sec: e.target.result
                            }
                        }, () => {
                            chrome.runtime.sendMessage(document.head.dataset.extensionId || ``, { updateData: true });
                            window.parent.location.reload();
                        });
                    };
                    fileReader.readAsDataURL($sec.files[0]);
                });
            });
            const sendList = [];
            const sendName = [];
            [2, 0, 1].forEach(type => {
                if (!types[type].need || types[type].complete || !signature.hasOwnProperty(type))
                    return;
                $form.insertAdjacentHTML(`beforeend`, `<button type="button" data-type="${type}" class="btn btn-success">&laquo;${types[type].name}&raquo;</button>`);
                sendList.push(type);
                sendName.push(types[type].name);
            });
            if (sendList.length > 1) {
                $form.insertAdjacentHTML(`beforeend`, `<button type="button" data-type="-1" class="btn btn-info">&laquo;${sendName.join(` &rArr; `)}&raquo;</button>`);
            }
            async function sign(type) {
                const $btn = $form.querySelector(`[data-type='${type}']`);
                if ($btn !== null)
                    $btn.disabled = true;
                const delay = () => {
                    const sign = signature[type];
                    const formData = new FormData();
                    formData.append(`QuickKeysForm[passphrase]`, sign.password);
                    formData.append(`QuickKeysForm[key1]`, new Blob([b64toBlob(sign.sec)]), `fuck.sec`);
                    return fetch($form.action, {
                        method: $form.method,
                        body: formData
                    }).then(response => response.text());
                };
                return await delay();
            }
            async function signAll() {
                let isError = false;
                for (const type of sendList)
                    await sign(type).then((data) => {
                        const isSubmit = data.indexOf(indexOfSubmit) >= 0;
                        if (!isSubmit)
                            isError = true;
                    }).catch(() => isError = true);
                if (isError)
                    document.body.innerHTML = `<h1 class="error">Ошибка!</h1>`;
                else
                    window.parent.location.reload();
            }
            $form.addEventListener(`click`, e => {
                const $btn = e.target.closest(`[data-type]`);
                if ($btn === null)
                    return;
                $btn.disabled = true;
                const type = +$btn.dataset.type;
                if (type >= 0) {
                    const sign = signature[type];
                    $password.value = sign.password;
                    let list = new DataTransfer();
                    list.items.add(new File([b64toBlob(sign.sec)], `${types[type].name}.sec`));
                    $sec.files = list.files;
                    $form.submit();
                }
                else
                    signAll();
            }, false);
        });
    }
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImV4dGVuc2lvbi9wYWdlL2FsbC1teWtleXMvYWxsLW15a2V5cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsUUFBUSxDQUFDLEtBQUssR0FBRyxXQUFXLENBQUM7QUFDN0I7SUFDQyxNQUFNLEtBQUssR0FBMkIsUUFBUSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUUsQ0FBQztJQUN0RSxLQUFLLENBQUMsWUFBWSxHQUFHLEtBQUssQ0FBQztJQUMzQixNQUFNLFNBQVMsR0FBd0IsS0FBSyxDQUFDLGFBQWEsQ0FBQyxpQkFBaUIsQ0FBRSxDQUFDO0lBQy9FLFNBQVMsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDO0lBQ3hDLE1BQU0sSUFBSSxHQUF3QixLQUFLLENBQUMsYUFBYSxDQUFDLGFBQWEsQ0FBRSxDQUFDO0lBQ3RFLElBQUksQ0FBQyxNQUFNLEdBQUssTUFBTSxDQUFDO0lBQ3ZCLE1BQU0sT0FBTyxHQUFzQixLQUFLLENBQUMsYUFBYSxDQUFDLGVBQWUsQ0FBRSxDQUFDO0lBQ3pFLE9BQU8sQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxhQUFhLENBQUMsQ0FBQztJQUM1QyxLQUFLLENBQUMsWUFBWSxHQUFHLEtBQUssQ0FBQztJQUUzQixRQUFRLENBQUMsZ0JBQWdCLENBQUMsZUFBZSxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLGNBQWMsQ0FBQyxDQUFDLENBQUM7SUFFMUcsTUFBTSxTQUFTLEdBQUcsQ0FBQyxPQUFlLEVBQUUsV0FBVyxHQUFHLDBCQUEwQixFQUFFLFNBQVMsR0FBRyxHQUFHLEVBQUUsRUFBRTtRQUNoRyxJQUFJLGNBQWMsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDbkMsSUFBSSxVQUFVLEdBQU8sRUFBRSxDQUFDO1FBQ3hCLEtBQUssSUFBSSxNQUFNLEdBQUcs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QyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLEVBQUU7Z0JBQ25DLE1BQU0sSUFBSSxHQUEyQyxDQUFDLENBQUMsTUFBTyxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztnQkFDdEYsSUFBSSxJQUFJLEtBQUssSUFBSTtvQkFBRSxPQUFPO2dCQUMxQixJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztnQkFDckIsTUFBTSxJQUFJLEdBQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUssQ0FBQztnQkFDcEMsSUFBSSxJQUFJLElBQUksQ0FBQyxFQUFFO29CQUNkLE1BQU0sSUFBSSxHQUFRLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDbEMsU0FBUyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDO29CQUNoQyxJQUFJLElBQUksR0FBVSxJQUFJLFlBQVksRUFBRSxDQUFDO29CQUNyQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksQ0FBQyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxDQUFDLENBQUM7b0JBQzNFLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztvQkFDeEIsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDO2lCQUNmOztvQkFBTSxPQUFPLEVBQUUsQ0FBQztZQUNsQixDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDWCxDQUFDLENBQUMsQ0FBQztLQUNKO0NBQ0QiLCJmaWxlIjoiZXh0ZW5zaW9uL3BhZ2UvYWxsLW15a2V5cy9hbGwtbXlrZXlzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiZG9jdW1lbnQudGl0bGUgPSBg0J/QvtC00L/QuNGB0LDRgtGMYDtcbntcblx0Y29uc3QgJGZvcm0gICAgICAgID0gPEhUTUxGb3JtRWxlbWVudD5kb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBmb3JtYCkhO1xuXHQkZm9ybS5hdXRvY29tcGxldGUgPSBgb2ZmYDtcblx0Y29uc3QgJHBhc3N3b3JkICAgID0gPEhUTUxJbnB1dEVsZW1lbnQ+JGZvcm0ucXVlcnlTZWxlY3RvcihgW3R5cGU9cGFzc3dvcmRdYCkhO1xuXHQkcGFzc3dvcmQuY2xhc3NMaXN0LmFkZChgZm9ybS1jb250cm9sYCk7XG5cdGNvbnN0ICRzZWMgICAgPSA8SFRNTElucHV0RWxlbWVudD4kZm9ybS5xdWVyeVNlbGVjdG9yKGBbdHlwZT1maWxlXWApITtcblx0JHNlYy5hY2NlcHQgICA9IGAuc2VjYDtcblx0Y29uc3QgJHN1Ym1pdCA9IDxIVE1MQnV0dG9uRWxlbWVudD4kZm9ybS5xdWVyeVNlbGVjdG9yKGBbdHlwZT1zdWJtaXRdYCkhO1xuXHQkc3VibWl0LmNsYXNzTGlzdC5hZGQoYGJ0bmAsIGBidG4tcHJpbWFyeWApO1xuXHQkZm9ybS5hdXRvY29tcGxldGUgPSBgb2ZmYDtcblx0XG5cdGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoYC5lcnJvclN1bW1hcnlgKS5mb3JFYWNoKCRlbGVtID0+ICRlbGVtLmNsYXNzTGlzdC5hZGQoYGFsZXJ0YCwgYGFsZXJ0LWRhbmdlcmApKTtcblx0XG5cdGNvbnN0IGI2NHRvQmxvYiA9IChiNjREYXRhOiBzdHJpbmcsIGNvbnRlbnRUeXBlID0gJ2FwcGxpY2F0aW9uL29jdGV0LXN0cmVhbScsIHNsaWNlU2l6ZSA9IDUxMikgPT4ge1xuXHRcdGxldCBieXRlQ2hhcmFjdGVycyA9IGF0b2IoYjY0RGF0YSk7XG5cdFx0bGV0IGJ5dGVBcnJheXMgICAgID0gW107XG5cdFx0Zm9yIChsZXQgb2Zmc2V0ID0gMDsgb2Zmc2V0IDwgYnl0ZUNoYXJhY3RlcnMubGVuZ3RoOyBvZmZzZXQgKz0gc2xpY2VTaXplKSB7XG5cdFx0XHRsZXQgc2xpY2UgICAgICAgPSBieXRlQ2hhcmFjdGVycy5zbGljZShvZmZzZXQsIG9mZnNldCArIHNsaWNlU2l6ZSk7XG5cdFx0XHRsZXQgYnl0ZU51bWJlcnMgPSBuZXcgQXJyYXkoc2xpY2UubGVuZ3RoKTtcblx0XHRcdGZvciAobGV0IGkgPSAwOyBpIDwgc2xpY2UubGVuZ3RoOyBpKyspIHtcblx0XHRcdFx0Ynl0ZU51bWJlcnNbaV0gPSBzbGljZS5jaGFyQ29kZUF0KGkpO1xuXHRcdFx0fVxuXHRcdFx0bGV0IGJ5dGVBcnJheSA9IG5ldyBVaW50OEFycmF5KGJ5dGVOdW1iZXJzKTtcblx0XHRcdGJ5dGVBcnJheXMucHVzaChieXRlQXJyYXkpO1xuXHRcdH1cblx0XHRyZXR1cm4gbmV3IEJsb2IoYnl0ZUFycmF5cywge3R5cGU6IGNvbnRlbnRUeXBlfSk7XG5cdH1cblx0XG5cdGNvbnN0IGluZGV4T2ZTdWJtaXQgPSBgd2luZG93LnBhcmVudC4kLmZuLnlpaUdyaWRWaWV3LnVwZGF0ZWA7XG5cdGNvbnN0IHBhcmFtcyAgICAgICAgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKHdpbmRvdy5sb2NhdGlvbi5zZWFyY2gpO1xuXHRpZiAocGFyYW1zLmhhcyhgY2xpZW50SWRgKSAmJiBwYXJhbXMuaGFzKGB0eXBlYCkpIHtcblx0XHRjb25zdCBjbGllbnRJZCA9IHBhcmFtcy5nZXQoYGNsaWVudElkYCk7XG5cdFx0Y29uc3QgdHlwZXMgICAgPSBKU09OLnBhcnNlKHBhcmFtcy5nZXQoYHR5cGVgKSB8fCBge31gKTtcblx0XHRcblx0XHRjaHJvbWUucnVudGltZS5zZW5kTWVzc2FnZShcblx0XHRcdGRvY3VtZW50LmhlYWQuZGF0YXNldC5leHRlbnNpb25JZCB8fCBgYCxcblx0XHRcdHtnZXRDbGllbnRTaWduYXR1cmU6IGNsaWVudElkfSxcblx0XHRcdChzaWduYXR1cmUpID0+IHtcblx0XHRcdFx0bGV0IHR5cGVDdXJyZW50ID0gWzIsIDAsIDFdLmZpbmQodHlwZSA9PiB0eXBlc1t0eXBlXS5uZWVkICYmICF0eXBlc1t0eXBlXS5jb21wbGV0ZSk7XG5cdFx0XHRcdGlmICh0eXBlQ3VycmVudCA9PT0gdW5kZWZpbmVkKSByZXR1cm47XG5cdFx0XHRcdCRzdWJtaXQuaW5zZXJ0QWRqYWNlbnRIVE1MKCdiZWZvcmViZWdpbicsIGA8bGFiZWwgY2xhc3M9XCJzd2l0Y2gtd3JhcFwiPjxkaXYgY2xhc3M9XCJzd2l0Y2hcIj48aW5wdXQgdHlwZT1cImNoZWNrYm94XCIgY2hlY2tlZCBhdXRvY29tcGxldGU9XCJvZmZcIiBuYW1lPVwic2F2ZVwiPjxkaXY+PHNwYW4+PC9zcGFuPjwvZGl2PjwvZGl2PtCh0L7RhdGA0LDQvdC40YLRjCDQutCw0LogJmxhcXVvOyR7dHlwZXNbdHlwZUN1cnJlbnRdLm5hbWV9JnJhcXVvOzwvbGFiZWw+YCk7XG5cdFx0XHRcdFxuXHRcdFx0XHQvLyBzdWJtaXRcblx0XHRcdFx0JGZvcm0uYWRkRXZlbnRMaXN0ZW5lcihgc3VibWl0YCwgZSA9PiB7XG5cdFx0XHRcdFx0Y29uc3QgJGNoZWNrYm94ICA9IDxIVE1MSW5wdXRFbGVtZW50PiRmb3JtLnF1ZXJ5U2VsZWN0b3IoYFt0eXBlPWNoZWNrYm94XWApO1xuXHRcdFx0XHRcdGNvbnN0IGZvcm1EYXRhICAgPSBuZXcgRm9ybURhdGEoJGZvcm0pO1xuXHRcdFx0XHRcdCRzdWJtaXQuZGlzYWJsZWQgPSB0cnVlO1xuXHRcdFx0XHRcdGlmICgkY2hlY2tib3ggPT09IG51bGwgfHwgISRjaGVja2JveC5jaGVja2VkIHx8ICRzZWMuZmlsZXMhLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuXHRcdFx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRmZXRjaCgkZm9ybS5hY3Rpb24sIHtcblx0XHRcdFx0XHRcdG1ldGhvZDogJGZvcm0ubWV0aG9kLFxuXHRcdFx0XHRcdFx0Ym9keSAgOiBuZXcgRm9ybURhdGEoJGZvcm0pXG5cdFx0XHRcdFx0fSlcblx0XHRcdFx0XHRcdC50aGVuKHJlc3BvbnNlID0+IHJlc3BvbnNlLnRleHQoKSlcblx0XHRcdFx0XHRcdC50aGVuKGRhdGEgPT4ge1xuXHRcdFx0XHRcdFx0XHRjb25zdCBpc1N1Ym1pdCA9IGRhdGEuaW5kZXhPZihpbmRleE9mU3VibWl0KSA+PSAwO1xuXHRcdFx0XHRcdFx0XHRpZiAoIWlzU3VibWl0KSByZXR1cm4gJGZvcm0uc3VibWl0KCk7XG5cdFx0XHRcdFx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcblx0XHRcdFx0XHRcdFx0Y29uc3QgZmlsZVJlYWRlciAgPSBuZXcgRmlsZVJlYWRlcigpO1xuXHRcdFx0XHRcdFx0XHRmaWxlUmVhZGVyLm9ubG9hZCA9IGUgPT4ge1xuXHRcdFx0XHRcdFx0XHRcdGNocm9tZS5ydW50aW1lLnNlbmRNZXNzYWdlKFxuXHRcdFx0XHRcdFx0XHRcdFx0ZG9jdW1lbnQuaGVhZC5kYXRhc2V0LmV4dGVuc2lvbklkIHx8IGBgLFxuXHRcdFx0XHRcdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRzYXZlU2lnbmF0dXJlOiB7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0Y2xpZW50ICA6IGNsaWVudElkLFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdHR5cGUgICAgOiB0eXBlQ3VycmVudCxcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRwYXNzd29yZDogZm9ybURhdGEuZ2V0KGBRdWlja0tleXNGb3JtW3Bhc3NwaHJhc2VdYCksXG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0c2VjICAgICA6IChlLnRhcmdldCEucmVzdWx0IGFzIHN0cmluZylcblx0XHRcdFx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHRcdFx0fSxcblx0XHRcdFx0XHRcdFx0XHRcdCgpID0+IHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0Y2hyb21lLnJ1bnRpbWUuc2VuZE1lc3NhZ2UoZG9jdW1lbnQuaGVhZC5kYXRhc2V0LmV4dGVuc2lvbklkIHx8IGBgLCB7dXBkYXRlRGF0YTogdHJ1ZX0pO1xuXHRcdFx0XHRcdFx0XHRcdFx0XHR3aW5kb3cucGFyZW50LmxvY2F0aW9uLnJlbG9hZCgpO1xuXHRcdFx0XHRcdFx0XHRcdFx0fSk7XG5cdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0ZmlsZVJlYWRlci5yZWFkQXNEYXRhVVJMKCRzZWMuZmlsZXMhWzBdKTtcblx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHR9KTtcblx0XHRcdFx0XG5cdFx0XHRcdC8vIGF1dG9cblx0XHRcdFx0Y29uc3Qgc2VuZExpc3Q6IG51bWJlcltdID0gW107XG5cdFx0XHRcdGNvbnN0IHNlbmROYW1lOiBzdHJpbmdbXSA9IFtdO1xuXHRcdFx0XHRcblx0XHRcdFx0WzIsIDAsIDFdLmZvckVhY2godHlwZSA9PiB7XG5cdFx0XHRcdFx0aWYgKCF0eXBlc1t0eXBlXS5uZWVkIHx8IHR5cGVzW3R5cGVdLmNvbXBsZXRlIHx8ICFzaWduYXR1cmUuaGFzT3duUHJvcGVydHkodHlwZSkpIHJldHVybjtcblx0XHRcdFx0XHQkZm9ybS5pbnNlcnRBZGphY2VudEhUTUwoYGJlZm9yZWVuZGAsIGA8YnV0dG9uIHR5cGU9XCJidXR0b25cIiBkYXRhLXR5cGU9XCIke3R5cGV9XCIgY2xhc3M9XCJidG4gYnRuLXN1Y2Nlc3NcIj4mbGFxdW87JHt0eXBlc1t0eXBlXS5uYW1lfSZyYXF1bzs8L2J1dHRvbj5gKTtcblx0XHRcdFx0XHRzZW5kTGlzdC5wdXNoKHR5cGUpO1xuXHRcdFx0XHRcdHNlbmROYW1lLnB1c2godHlwZXNbdHlwZV0ubmFtZSlcblx0XHRcdFx0fSk7XG5cdFx0XHRcdFxuXHRcdFx0XHRpZiAoc2VuZExpc3QubGVuZ3RoID4gMSkge1xuXHRcdFx0XHRcdCRmb3JtLmluc2VydEFkamFjZW50SFRNTChgYmVmb3JlZW5kYCwgYDxidXR0b24gdHlwZT1cImJ1dHRvblwiIGRhdGEtdHlwZT1cIi0xXCIgY2xhc3M9XCJidG4gYnRuLWluZm9cIj4mbGFxdW87JHtzZW5kTmFtZS5qb2luKGAgJnJBcnI7IGApfSZyYXF1bzs8L2J1dHRvbj5gKTtcblx0XHRcdFx0fVxuXHRcdFx0XHRcblx0XHRcdFx0YXN5bmMgZnVuY3Rpb24gc2lnbih0eXBlOiBudW1iZXIpIHtcblx0XHRcdFx0XHRjb25zdCAkYnRuID0gPEhUTUxCdXR0b25FbGVtZW50PiRmb3JtLnF1ZXJ5U2VsZWN0b3IoYFtkYXRhLXR5cGU9JyR7dHlwZX0nXWApO1xuXHRcdFx0XHRcdGlmICgkYnRuICE9PSBudWxsKSAkYnRuLmRpc2FibGVkID0gdHJ1ZTtcblx0XHRcdFx0XHRjb25zdCBkZWxheSA9ICgpID0+IHtcblx0XHRcdFx0XHRcdGNvbnN0IHNpZ24gICAgID0gc2lnbmF0dXJlW3R5cGVdO1xuXHRcdFx0XHRcdFx0Y29uc3QgZm9ybURhdGEgPSBuZXcgRm9ybURhdGEoKTtcblx0XHRcdFx0XHRcdGZvcm1EYXRhLmFwcGVuZChgUXVpY2tLZXlzRm9ybVtwYXNzcGhyYXNlXWAsIHNpZ24ucGFzc3dvcmQpXG5cdFx0XHRcdFx0XHRmb3JtRGF0YS5hcHBlbmQoYFF1aWNrS2V5c0Zvcm1ba2V5MV1gLCBuZXcgQmxvYihbYjY0dG9CbG9iKHNpZ24uc2VjKV0pLCBgZnVjay5zZWNgKTtcblx0XHRcdFx0XHRcdHJldHVybiBmZXRjaCgkZm9ybS5hY3Rpb24sIHtcblx0XHRcdFx0XHRcdFx0bWV0aG9kOiAkZm9ybS5tZXRob2QsXG5cdFx0XHRcdFx0XHRcdGJvZHkgIDogZm9ybURhdGFcblx0XHRcdFx0XHRcdH0pLnRoZW4ocmVzcG9uc2UgPT4gcmVzcG9uc2UudGV4dCgpKVxuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRyZXR1cm4gYXdhaXQgZGVsYXkoKTtcblx0XHRcdFx0fVxuXHRcdFx0XHRcblx0XHRcdFx0YXN5bmMgZnVuY3Rpb24gc2lnbkFsbCgpIHtcblx0XHRcdFx0XHRsZXQgaXNFcnJvciA9IGZhbHNlO1xuXHRcdFx0XHRcdGZvciAoY29uc3QgdHlwZSBvZiBzZW5kTGlzdCkgYXdhaXQgc2lnbih0eXBlKS50aGVuKChkYXRhKSA9PiB7XG5cdFx0XHRcdFx0XHRjb25zdCBpc1N1Ym1pdCA9IGRhdGEuaW5kZXhPZihpbmRleE9mU3VibWl0KSA+PSAwO1xuXHRcdFx0XHRcdFx0aWYgKCFpc1N1Ym1pdCkgaXNFcnJvciA9IHRydWU7XG5cdFx0XHRcdFx0fSkuY2F0Y2goKCkgPT4gaXNFcnJvciA9IHRydWUpO1xuXHRcdFx0XHRcdGlmIChpc0Vycm9yKSBkb2N1bWVudC5ib2R5LmlubmVySFRNTCA9IGA8aDEgY2xhc3M9XCJlcnJvclwiPtCe0YjQuNCx0LrQsCE8L2gxPmA7XG5cdFx0XHRcdFx0ZWxzZSB3aW5kb3cucGFyZW50LmxvY2F0aW9uLnJlbG9hZCgpO1xuXHRcdFx0XHR9XG5cdFx0XHRcdFxuXHRcdFx0XHQkZm9ybS5hZGRFdmVudExpc3RlbmVyKGBjbGlja2AsIGUgPT4ge1xuXHRcdFx0XHRcdGNvbnN0ICRidG46IEhUTUxCdXR0b25FbGVtZW50IHwgbnVsbCA9ICg8SFRNTEVsZW1lbnQ+ZS50YXJnZXQpLmNsb3Nlc3QoYFtkYXRhLXR5cGVdYCk7XG5cdFx0XHRcdFx0aWYgKCRidG4gPT09IG51bGwpIHJldHVybjtcblx0XHRcdFx0XHQkYnRuLmRpc2FibGVkID0gdHJ1ZTtcblx0XHRcdFx0XHRjb25zdCB0eXBlICAgID0gKyRidG4uZGF0YXNldC50eXBlITtcblx0XHRcdFx0XHRpZiAodHlwZSA+PSAwKSB7XG5cdFx0XHRcdFx0XHRjb25zdCBzaWduICAgICAgPSBzaWduYXR1cmVbdHlwZV07XG5cdFx0XHRcdFx0XHQkcGFzc3dvcmQudmFsdWUgPSBzaWduLnBhc3N3b3JkO1xuXHRcdFx0XHRcdFx0bGV0IGxpc3QgICAgICAgID0gbmV3IERhdGFUcmFuc2ZlcigpO1xuXHRcdFx0XHRcdFx0bGlzdC5pdGVtcy5hZGQobmV3IEZpbGUoW2I2NHRvQmxvYihzaWduLnNlYyldLCBgJHt0eXBlc1t0eXBlXS5uYW1lfS5zZWNgKSk7XG5cdFx0XHRcdFx0XHQkc2VjLmZpbGVzID0gbGlzdC5maWxlcztcblx0XHRcdFx0XHRcdCRmb3JtLnN1Ym1pdCgpO1xuXHRcdFx0XHRcdH0gZWxzZSBzaWduQWxsKCk7XG5cdFx0XHRcdH0sIGZhbHNlKTtcblx0XHRcdH0pO1xuXHR9XG59Il19
