"use strict";
document.title = `Подписать`;
{
    const $form = document.querySelector(`form`);
    $form.autocomplete = `off`;
    const $password = $form.querySelector(`[type=password]`);
    $password.classList.add(`form-control`);
    const $sec = $form.querySelector(`[type=file]`);
    $sec.accept = `.sec`;
    const $submit = $form.querySelector(`[type=submit]`);
    $submit.classList.add(`btn`, `btn-primary`);
    $form.autocomplete = `off`;
    document.querySelectorAll(`.errorSummary`).forEach($elem => $elem.classList.add(`alert`, `alert-danger`));
    const b64toBlob = (b64Data, contentType = 'application/octet-stream', sliceSize = 512) => {
        let byteCharacters = atob(b64Data);
        let byteArrays = [];
        for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
            let slice = byteCharacters.slice(offset, offset + sliceSize);
            let byteNumbers = new Array(slice.length);
            for (let i = 0; i < slice.length; i++) {
                byteNumbers[i] = slice.charCodeAt(i);
            }
            let byteArray = new Uint8Array(byteNumbers);
            byteArrays.push(byteArray);
        }
        return new Blob(byteArrays, { type: contentType });
    };
    const indexOfSubmit = `window.parent.$.fn.yiiGridView.update`;
    const params = new URLSearchParams(window.location.search);
    if (params.has(`clientId`) && params.has(`type`)) {
        const clientId = params.get(`clientId`);
        const types = JSON.parse(params.get(`type`) || `{}`);
        chrome.runtime.sendMessage(document.head.dataset.extensionId || ``, { getClientSignature: clientId }, (signature) => {
            let typeCurrent = [2, 0, 1].find(type => types[type].need && !types[type].complete);
            if (typeCurrent === undefined)
                return;
            $submit.insertAdjacentHTML('beforebegin', `<label class="switch-wrap"><div class="switch"><input type="checkbox" checked autocomplete="off" name="save"><div><span></span></div></div>Сохранить как &laquo;${types[typeCurrent].name}&raquo;</label>`);
            $form.addEventListener(`submit`, e => {
                const $checkbox = $form.querySelector(`[type=checkbox]`);
                const formData = new FormData($form);
                $submit.disabled = true;
                if ($checkbox === null || !$checkbox.checked || $sec.files.length === 0)
                    return;
                e.preventDefault();
                fetch($form.action, {
                    method: $form.method,
                    body: new FormData($form)
                })
                    .then(response => response.text())
                    .then(data => {
                    const isSubmit = data.indexOf(indexOfSubmit) >= 0;
                    if (!isSubmit)
                        return $form.submit();
                    e.preventDefault();
                    const fileReader = new FileReader();
                    fileReader.onload = e => {
                        chrome.runtime.sendMessage(document.head.dataset.extensionId || ``, {
                            saveSignature: {
                                client: clientId,
                                type: typeCurrent,
                                password: formData.get(`QuickKeysForm[passphrase]`),
                                sec: e.target.result
                            }
                        }, () => {
                            chrome.runtime.sendMessage(document.head.dataset.extensionId || ``, { updateData: true });
                            window.parent.location.reload();
                        });
                    };
                    fileReader.readAsDataURL($sec.files[0]);
                });
            });
            const sendList = [];
            const sendName = [];
            [2, 0, 1].forEach(type => {
                if (!types[type].need || types[type].complete || !signature.hasOwnProperty(type))
                    return;
                $form.insertAdjacentHTML(`beforeend`, `<button type="button" data-type="${type}" class="btn btn-success">&laquo;${types[type].name}&raquo;</button>`);
                sendList.push(type);
                sendName.push(types[type].name);
            });
            if (sendList.length > 1) {
                $form.insertAdjacentHTML(`beforeend`, `<button type="button" data-type="-1" class="btn btn-info">&laquo;${sendName.join(` &rArr; `)}&raquo;</button>`);
            }
            async function sign(type) {
                const $btn = $form.querySelector(`[data-type='${type}']`);
                if ($btn !== null)
                    $btn.disabled = true;
                const delay = () => {
                    const sign = signature[type];
                    const formData = new FormData();
                    formData.append(`QuickKeysForm[passphrase]`, sign.password);
                    formData.append(`QuickKeysForm[key1]`, new Blob([b64toBlob(sign.sec)]), `fuck.sec`);
                    return fetch($form.action, {
                        method: $form.method,
                        body: formData
                    }).then(response => response.text());
                };
                return await delay();
            }
            async function signAll() {
                let isError = false;
                for (const type of sendList)
                    await sign(type).then((data) => {
                        const isSubmit = data.indexOf(indexOfSubmit) >= 0;
                        if (!isSubmit)
                            isError = true;
                    }).catch(() => isError = true);
                if (isError)
                    document.body.innerHTML = `<h1 class="error">Ошибка!</h1>`;
                else
                    window.parent.location.reload();
            }
            $form.addEventListener(`click`, e => {
                const $btn = e.target.closest(`[data-type]`);
                if ($btn === null)
                    return;
                $btn.disabled = true;
                const type = +$btn.dataset.type;
                if (type >= 0) {
                    const sign = signature[type];
                    $password.value = sign.password;
                    let list = new DataTransfer();
                    list.items.add(new File([b64toBlob(sign.sec)], `${types[type].name}.sec`));
                    $sec.files = list.files;
                    $form.submit();
                }
                else
                    signAll();
            }, false);
        });
    }
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImV4dGVuc2lvbi9wYWdlL2FsbC1teWtleXMvYWxsLW15a2V5cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsUUFBUSxDQUFDLEtBQUssR0FBRyxXQUFXLENBQUM7QUFDN0I7SUFDQyxNQUFNLEtBQUssR0FBMkIsUUFBUSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUUsQ0FBQztJQUN0RSxLQUFLLENBQUMsWUFBWSxHQUFHLEtBQUssQ0FBQztJQUMzQixNQUFNLFNBQVMsR0FBd0IsS0FBSyxDQUFDLGFBQWEsQ0FBQyxpQkFBaUIsQ0FBRSxDQUFDO0lBQy9FLFNBQVMsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDO0lBQ3hDLE1BQU0sSUFBSSxHQUF3QixLQUFLLENBQUMsYUFBYSxDQUFDLGFBQWEsQ0FBRSxDQUFDO0lBQ3RFLElBQUksQ0FBQyxNQUFNLEdBQUssTUFBTSxDQUFDO0lBQ3ZCLE1BQU0sT0FBTyxHQUFzQixLQUFLLENBQUMsYUFBYSxDQUFDLGVBQWUsQ0FBRSxDQUFDO0lBQ3pFLE9BQU8sQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxhQUFhLENBQUMsQ0FBQztJQUM1QyxLQUFLLENBQUMsWUFBWSxHQUFHLEtBQUssQ0FBQztJQUUzQixRQUFRLENBQUMsZ0JBQWdCLENBQUMsZUFBZSxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLGNBQWMsQ0FBQyxDQUFDLENBQUM7SUFFMUcsTUFBTSxTQUFTLEdBQUcsQ0FBQyxPQUFlLEVBQUUsV0FBVyxHQUFHLDBCQUEwQixFQUFFLFNBQVMsR0FBRyxHQUFHLEVBQUUsRUFBRTtRQUNoRyxJQUFJLGNBQWMsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDbkMsSUFBSSxVQUFVLEdBQU8sRUFBRSxDQUFDO1FBQ3hCLEtBQUssSUFBSSxNQUFNLEdBQUcs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QyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLEVBQUU7Z0JBQ25DLE1BQU0sSUFBSSxHQUEyQyxDQUFDLENBQUMsTUFBTyxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztnQkFDdEYsSUFBSSxJQUFJLEtBQUssSUFBSTtvQkFBRSxPQUFPO2dCQUMxQixJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztnQkFDckIsTUFBTSxJQUFJLEdBQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUssQ0FBQztnQkFDcEMsSUFBSSxJQUFJLElBQUksQ0FBQyxFQUFFO29CQUNkLE1BQU0sSUFBSSxHQUFRLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDbEMsU0FBUyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDO29CQUNoQyxJQUFJLElBQUksR0FBVSxJQUFJLFlBQVksRUFBRSxDQUFDO29CQUNyQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksQ0FBQyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxDQUFDLENBQUM7b0JBQzNFLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztvQkFDeEIsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDO2lCQUNmOztvQkFBTSxPQUFPLEVBQUUsQ0FBQztZQUNsQixDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDWCxDQUFDLENBQUMsQ0FBQztLQUNKO0NBQ0QiLCJmaWxlIjoiZXh0ZW5zaW9uL3BhZ2UvYWxsLW15a2V5cy9hbGwtbXlrZXlzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiZG9jdW1lbnQudGl0bGUgPSBg0J/QvtC00L/QuNGB0LDRgtGMYDtcclxue1xyXG5cdGNvbnN0ICRmb3JtICAgICAgICA9IDxIVE1MRm9ybUVsZW1lbnQ+ZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgZm9ybWApITtcclxuXHQkZm9ybS5hdXRvY29tcGxldGUgPSBgb2ZmYDtcclxuXHRjb25zdCAkcGFzc3dvcmQgICAgPSA8SFRNTElucHV0RWxlbWVudD4kZm9ybS5xdWVyeVNlbGVjdG9yKGBbdHlwZT1wYXNzd29yZF1gKSE7XHJcblx0JHBhc3N3b3JkLmNsYXNzTGlzdC5hZGQoYGZvcm0tY29udHJvbGApO1xyXG5cdGNvbnN0ICRzZWMgICAgPSA8SFRNTElucHV0RWxlbWVudD4kZm9ybS5xdWVyeVNlbGVjdG9yKGBbdHlwZT1maWxlXWApITtcclxuXHQkc2VjLmFjY2VwdCAgID0gYC5zZWNgO1xyXG5cdGNvbnN0ICRzdWJtaXQgPSA8SFRNTEJ1dHRvbkVsZW1lbnQ+JGZvcm0ucXVlcnlTZWxlY3RvcihgW3R5cGU9c3VibWl0XWApITtcclxuXHQkc3VibWl0LmNsYXNzTGlzdC5hZGQoYGJ0bmAsIGBidG4tcHJpbWFyeWApO1xyXG5cdCRmb3JtLmF1dG9jb21wbGV0ZSA9IGBvZmZgO1xyXG5cdFxyXG5cdGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoYC5lcnJvclN1bW1hcnlgKS5mb3JFYWNoKCRlbGVtID0+ICRlbGVtLmNsYXNzTGlzdC5hZGQoYGFsZXJ0YCwgYGFsZXJ0LWRhbmdlcmApKTtcclxuXHRcclxuXHRjb25zdCBiNjR0b0Jsb2IgPSAoYjY0RGF0YTogc3RyaW5nLCBjb250ZW50VHlwZSA9ICdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nLCBzbGljZVNpemUgPSA1MTIpID0+IHtcclxuXHRcdGxldCBieXRlQ2hhcmFjdGVycyA9IGF0b2IoYjY0RGF0YSk7XHJcblx0XHRsZXQgYnl0ZUFycmF5cyAgICAgPSBbXTtcclxuXHRcdGZvciAobGV0IG9mZnNldCA9IDA7IG9mZnNldCA8IGJ5dGVDaGFyYWN0ZXJzLmxlbmd0aDsgb2Zmc2V0ICs9IHNsaWNlU2l6ZSkge1xyXG5cdFx0XHRsZXQgc2xpY2UgICAgICAgPSBieXRlQ2hhcmFjdGVycy5zbGljZShvZmZzZXQsIG9mZnNldCArIHNsaWNlU2l6ZSk7XHJcblx0XHRcdGxldCBieXRlTnVtYmVycyA9IG5ldyBBcnJheShzbGljZS5sZW5ndGgpO1xyXG5cdFx0XHRmb3IgKGxldCBpID0gMDsgaSA8IHNsaWNlLmxlbmd0aDsgaSsrKSB7XHJcblx0XHRcdFx0Ynl0ZU51bWJlcnNbaV0gPSBzbGljZS5jaGFyQ29kZUF0KGkpO1xyXG5cdFx0XHR9XHJcblx0XHRcdGxldCBieXRlQXJyYXkgPSBuZXcgVWludDhBcnJheShieXRlTnVtYmVycyk7XHJcblx0XHRcdGJ5dGVBcnJheXMucHVzaChieXRlQXJyYXkpO1xyXG5cdFx0fVxyXG5cdFx0cmV0dXJuIG5ldyBCbG9iKGJ5dGVBcnJheXMsIHt0eXBlOiBjb250ZW50VHlwZX0pO1xyXG5cdH1cclxuXHRcclxuXHRjb25zdCBpbmRleE9mU3VibWl0ID0gYHdpbmRvdy5wYXJlbnQuJC5mbi55aWlHcmlkVmlldy51cGRhdGVgO1xyXG5cdGNvbnN0IHBhcmFtcyAgICAgICAgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKHdpbmRvdy5sb2NhdGlvbi5zZWFyY2gpO1xyXG5cdGlmIChwYXJhbXMuaGFzKGBjbGllbnRJZGApICYmIHBhcmFtcy5oYXMoYHR5cGVgKSkge1xyXG5cdFx0Y29uc3QgY2xpZW50SWQgPSBwYXJhbXMuZ2V0KGBjbGllbnRJZGApO1xyXG5cdFx0Y29uc3QgdHlwZXMgICAgPSBKU09OLnBhcnNlKHBhcmFtcy5nZXQoYHR5cGVgKSB8fCBge31gKTtcclxuXHRcdFxyXG5cdFx0Y2hyb21lLnJ1bnRpbWUuc2VuZE1lc3NhZ2UoXHJcblx0XHRcdGRvY3VtZW50LmhlYWQuZGF0YXNldC5leHRlbnNpb25JZCB8fCBgYCxcclxuXHRcdFx0e2dldENsaWVudFNpZ25hdHVyZTogY2xpZW50SWR9LFxyXG5cdFx0XHQoc2lnbmF0dXJlKSA9PiB7XHJcblx0XHRcdFx0bGV0IHR5cGVDdXJyZW50ID0gWzIsIDAsIDFdLmZpbmQodHlwZSA9PiB0eXBlc1t0eXBlXS5uZWVkICYmICF0eXBlc1t0eXBlXS5jb21wbGV0ZSk7XHJcblx0XHRcdFx0aWYgKHR5cGVDdXJyZW50ID09PSB1bmRlZmluZWQpIHJldHVybjtcclxuXHRcdFx0XHQkc3VibWl0Lmluc2VydEFkamFjZW50SFRNTCgnYmVmb3JlYmVnaW4nLCBgPGxhYmVsIGNsYXNzPVwic3dpdGNoLXdyYXBcIj48ZGl2IGNsYXNzPVwic3dpdGNoXCI+PGlucHV0IHR5cGU9XCJjaGVja2JveFwiIGNoZWNrZWQgYXV0b2NvbXBsZXRlPVwib2ZmXCIgbmFtZT1cInNhdmVcIj48ZGl2PjxzcGFuPjwvc3Bhbj48L2Rpdj48L2Rpdj7QodC+0YXRgNCw0L3QuNGC0Ywg0LrQsNC6ICZsYXF1bzske3R5cGVzW3R5cGVDdXJyZW50XS5uYW1lfSZyYXF1bzs8L2xhYmVsPmApO1xyXG5cdFx0XHRcdFxyXG5cdFx0XHRcdC8vIHN1Ym1pdFxyXG5cdFx0XHRcdCRmb3JtLmFkZEV2ZW50TGlzdGVuZXIoYHN1Ym1pdGAsIGUgPT4ge1xyXG5cdFx0XHRcdFx0Y29uc3QgJGNoZWNrYm94ICA9IDxIVE1MSW5wdXRFbGVtZW50PiRmb3JtLnF1ZXJ5U2VsZWN0b3IoYFt0eXBlPWNoZWNrYm94XWApO1xyXG5cdFx0XHRcdFx0Y29uc3QgZm9ybURhdGEgICA9IG5ldyBGb3JtRGF0YSgkZm9ybSk7XHJcblx0XHRcdFx0XHQkc3VibWl0LmRpc2FibGVkID0gdHJ1ZTtcclxuXHRcdFx0XHRcdGlmICgkY2hlY2tib3ggPT09IG51bGwgfHwgISRjaGVja2JveC5jaGVja2VkIHx8ICRzZWMuZmlsZXMhLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xyXG5cdFx0XHRcdFx0ZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG5cdFx0XHRcdFx0XHJcblx0XHRcdFx0XHRmZXRjaCgkZm9ybS5hY3Rpb24sIHtcclxuXHRcdFx0XHRcdFx0bWV0aG9kOiAkZm9ybS5tZXRob2QsXHJcblx0XHRcdFx0XHRcdGJvZHkgIDogbmV3IEZvcm1EYXRhKCRmb3JtKVxyXG5cdFx0XHRcdFx0fSlcclxuXHRcdFx0XHRcdFx0LnRoZW4ocmVzcG9uc2UgPT4gcmVzcG9uc2UudGV4dCgpKVxyXG5cdFx0XHRcdFx0XHQudGhlbihkYXRhID0+IHtcclxuXHRcdFx0XHRcdFx0XHRjb25zdCBpc1N1Ym1pdCA9IGRhdGEuaW5kZXhPZihpbmRleE9mU3VibWl0KSA+PSAwO1xyXG5cdFx0XHRcdFx0XHRcdGlmICghaXNTdWJtaXQpIHJldHVybiAkZm9ybS5zdWJtaXQoKTtcclxuXHRcdFx0XHRcdFx0XHRlLnByZXZlbnREZWZhdWx0KCk7XHJcblx0XHRcdFx0XHRcdFx0Y29uc3QgZmlsZVJlYWRlciAgPSBuZXcgRmlsZVJlYWRlcigpO1xyXG5cdFx0XHRcdFx0XHRcdGZpbGVSZWFkZXIub25sb2FkID0gZSA9PiB7XHJcblx0XHRcdFx0XHRcdFx0XHRjaHJvbWUucnVudGltZS5zZW5kTWVzc2FnZShcclxuXHRcdFx0XHRcdFx0XHRcdFx0ZG9jdW1lbnQuaGVhZC5kYXRhc2V0LmV4dGVuc2lvbklkIHx8IGBgLFxyXG5cdFx0XHRcdFx0XHRcdFx0XHR7XHJcblx0XHRcdFx0XHRcdFx0XHRcdFx0c2F2ZVNpZ25hdHVyZToge1xyXG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0Y2xpZW50ICA6IGNsaWVudElkLFxyXG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0dHlwZSAgICA6IHR5cGVDdXJyZW50LFxyXG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0cGFzc3dvcmQ6IGZvcm1EYXRhLmdldChgUXVpY2tLZXlzRm9ybVtwYXNzcGhyYXNlXWApLFxyXG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0c2VjICAgICA6IChlLnRhcmdldCEucmVzdWx0IGFzIHN0cmluZylcclxuXHRcdFx0XHRcdFx0XHRcdFx0XHR9XHJcblx0XHRcdFx0XHRcdFx0XHRcdH0sXHJcblx0XHRcdFx0XHRcdFx0XHRcdCgpID0+IHtcclxuXHRcdFx0XHRcdFx0XHRcdFx0XHRjaHJvbWUucnVudGltZS5zZW5kTWVzc2FnZShkb2N1bWVudC5oZWFkLmRhdGFzZXQuZXh0ZW5zaW9uSWQgfHwgYGAsIHt1cGRhdGVEYXRhOiB0cnVlfSk7XHJcblx0XHRcdFx0XHRcdFx0XHRcdFx0d2luZG93LnBhcmVudC5sb2NhdGlvbi5yZWxvYWQoKTtcclxuXHRcdFx0XHRcdFx0XHRcdFx0fSk7XHJcblx0XHRcdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0XHRcdGZpbGVSZWFkZXIucmVhZEFzRGF0YVVSTCgkc2VjLmZpbGVzIVswXSk7XHJcblx0XHRcdFx0XHRcdH0pO1xyXG5cdFx0XHRcdH0pO1xyXG5cdFx0XHRcdFxyXG5cdFx0XHRcdC8vIGF1dG9cclxuXHRcdFx0XHRjb25zdCBzZW5kTGlzdDogbnVtYmVyW10gPSBbXTtcclxuXHRcdFx0XHRjb25zdCBzZW5kTmFtZTogc3RyaW5nW10gPSBbXTtcclxuXHRcdFx0XHRcclxuXHRcdFx0XHRbMiwgMCwgMV0uZm9yRWFjaCh0eXBlID0+IHtcclxuXHRcdFx0XHRcdGlmICghdHlwZXNbdHlwZV0ubmVlZCB8fCB0eXBlc1t0eXBlXS5jb21wbGV0ZSB8fCAhc2lnbmF0dXJlLmhhc093blByb3BlcnR5KHR5cGUpKSByZXR1cm47XHJcblx0XHRcdFx0XHQkZm9ybS5pbnNlcnRBZGphY2VudEhUTUwoYGJlZm9yZWVuZGAsIGA8YnV0dG9uIHR5cGU9XCJidXR0b25cIiBkYXRhLXR5cGU9XCIke3R5cGV9XCIgY2xhc3M9XCJidG4gYnRuLXN1Y2Nlc3NcIj4mbGFxdW87JHt0eXBlc1t0eXBlXS5uYW1lfSZyYXF1bzs8L2J1dHRvbj5gKTtcclxuXHRcdFx0XHRcdHNlbmRMaXN0LnB1c2godHlwZSk7XHJcblx0XHRcdFx0XHRzZW5kTmFtZS5wdXNoKHR5cGVzW3R5cGVdLm5hbWUpXHJcblx0XHRcdFx0fSk7XHJcblx0XHRcdFx0XHJcblx0XHRcdFx0aWYgKHNlbmRMaXN0Lmxlbmd0aCA+IDEpIHtcclxuXHRcdFx0XHRcdCRmb3JtLmluc2VydEFkamFjZW50SFRNTChgYmVmb3JlZW5kYCwgYDxidXR0b24gdHlwZT1cImJ1dHRvblwiIGRhdGEtdHlwZT1cIi0xXCIgY2xhc3M9XCJidG4gYnRuLWluZm9cIj4mbGFxdW87JHtzZW5kTmFtZS5qb2luKGAgJnJBcnI7IGApfSZyYXF1bzs8L2J1dHRvbj5gKTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdFx0XHJcblx0XHRcdFx0YXN5bmMgZnVuY3Rpb24gc2lnbih0eXBlOiBudW1iZXIpIHtcclxuXHRcdFx0XHRcdGNvbnN0ICRidG4gPSA8SFRNTEJ1dHRvbkVsZW1lbnQ+JGZvcm0ucXVlcnlTZWxlY3RvcihgW2RhdGEtdHlwZT0nJHt0eXBlfSddYCk7XHJcblx0XHRcdFx0XHRpZiAoJGJ0biAhPT0gbnVsbCkgJGJ0bi5kaXNhYmxlZCA9IHRydWU7XHJcblx0XHRcdFx0XHRjb25zdCBkZWxheSA9ICgpID0+IHtcclxuXHRcdFx0XHRcdFx0Y29uc3Qgc2lnbiAgICAgPSBzaWduYXR1cmVbdHlwZV07XHJcblx0XHRcdFx0XHRcdGNvbnN0IGZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7XHJcblx0XHRcdFx0XHRcdGZvcm1EYXRhLmFwcGVuZChgUXVpY2tLZXlzRm9ybVtwYXNzcGhyYXNlXWAsIHNpZ24ucGFzc3dvcmQpXHJcblx0XHRcdFx0XHRcdGZvcm1EYXRhLmFwcGVuZChgUXVpY2tLZXlzRm9ybVtrZXkxXWAsIG5ldyBCbG9iKFtiNjR0b0Jsb2Ioc2lnbi5zZWMpXSksIGBmdWNrLnNlY2ApO1xyXG5cdFx0XHRcdFx0XHRyZXR1cm4gZmV0Y2goJGZvcm0uYWN0aW9uLCB7XHJcblx0XHRcdFx0XHRcdFx0bWV0aG9kOiAkZm9ybS5tZXRob2QsXHJcblx0XHRcdFx0XHRcdFx0Ym9keSAgOiBmb3JtRGF0YVxyXG5cdFx0XHRcdFx0XHR9KS50aGVuKHJlc3BvbnNlID0+IHJlc3BvbnNlLnRleHQoKSlcclxuXHRcdFx0XHRcdH1cclxuXHRcdFx0XHRcdHJldHVybiBhd2FpdCBkZWxheSgpO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0XHRcclxuXHRcdFx0XHRhc3luYyBmdW5jdGlvbiBzaWduQWxsKCkge1xyXG5cdFx0XHRcdFx0bGV0IGlzRXJyb3IgPSBmYWxzZTtcclxuXHRcdFx0XHRcdGZvciAoY29uc3QgdHlwZSBvZiBzZW5kTGlzdCkgYXdhaXQgc2lnbih0eXBlKS50aGVuKChkYXRhKSA9PiB7XHJcblx0XHRcdFx0XHRcdGNvbnN0IGlzU3VibWl0ID0gZGF0YS5pbmRleE9mKGluZGV4T2ZTdWJtaXQpID49IDA7XHJcblx0XHRcdFx0XHRcdGlmICghaXNTdWJtaXQpIGlzRXJyb3IgPSB0cnVlO1xyXG5cdFx0XHRcdFx0fSkuY2F0Y2goKCkgPT4gaXNFcnJvciA9IHRydWUpO1xyXG5cdFx0XHRcdFx0aWYgKGlzRXJyb3IpIGRvY3VtZW50LmJvZHkuaW5uZXJIVE1MID0gYDxoMSBjbGFzcz1cImVycm9yXCI+0J7RiNC40LHQutCwITwvaDE+YDtcclxuXHRcdFx0XHRcdGVsc2Ugd2luZG93LnBhcmVudC5sb2NhdGlvbi5yZWxvYWQoKTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdFx0XHJcblx0XHRcdFx0JGZvcm0uYWRkRXZlbnRMaXN0ZW5lcihgY2xpY2tgLCBlID0+IHtcclxuXHRcdFx0XHRcdGNvbnN0ICRidG46IEhUTUxCdXR0b25FbGVtZW50IHwgbnVsbCA9ICg8SFRNTEVsZW1lbnQ+ZS50YXJnZXQpLmNsb3Nlc3QoYFtkYXRhLXR5cGVdYCk7XHJcblx0XHRcdFx0XHRpZiAoJGJ0biA9PT0gbnVsbCkgcmV0dXJuO1xyXG5cdFx0XHRcdFx0JGJ0bi5kaXNhYmxlZCA9IHRydWU7XHJcblx0XHRcdFx0XHRjb25zdCB0eXBlICAgID0gKyRidG4uZGF0YXNldC50eXBlITtcclxuXHRcdFx0XHRcdGlmICh0eXBlID49IDApIHtcclxuXHRcdFx0XHRcdFx0Y29uc3Qgc2lnbiAgICAgID0gc2lnbmF0dXJlW3R5cGVdO1xyXG5cdFx0XHRcdFx0XHQkcGFzc3dvcmQudmFsdWUgPSBzaWduLnBhc3N3b3JkO1xyXG5cdFx0XHRcdFx0XHRsZXQgbGlzdCAgICAgICAgPSBuZXcgRGF0YVRyYW5zZmVyKCk7XHJcblx0XHRcdFx0XHRcdGxpc3QuaXRlbXMuYWRkKG5ldyBGaWxlKFtiNjR0b0Jsb2Ioc2lnbi5zZWMpXSwgYCR7dHlwZXNbdHlwZV0ubmFtZX0uc2VjYCkpO1xyXG5cdFx0XHRcdFx0XHQkc2VjLmZpbGVzID0gbGlzdC5maWxlcztcclxuXHRcdFx0XHRcdFx0JGZvcm0uc3VibWl0KCk7XHJcblx0XHRcdFx0XHR9IGVsc2Ugc2lnbkFsbCgpO1xyXG5cdFx0XHRcdH0sIGZhbHNlKTtcclxuXHRcdFx0fSk7XHJcblx0fVxyXG59Il19
